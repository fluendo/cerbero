# FLUENDO S.A.
# Copyright (C) <2024>  <support@fluendo.com>
# Platform config file for the Web platform.
# It contains sensitive enviroment configuration that
# shouldn't be modified unless you know what you are doing.
# PLEASE, DO NOT EDIT THIS FILE

import os
import os.path
from cerbero.config import Distro, FatalError
from cerbero.utils import EnvValueCmd

if target_distro != Distro.EMSCRIPTEN:
    raise FatalError('EMSCRIPTEN is the only Distro supported for the WEB platform')

# These variants are enabled by default, but not available on our platform
variants.rust = False

# Init build envvars in the way it is done in linux, darwin, etc.
# And do += later
for f in ['CPPFLAGS', 'CFLAGS', 'CCASFLAGS', 'CXXFLAGS', 'LDFLAGS',
          'OBJCFLAGS']:
    env[f] = env.get(f, '')

COMMON_FLAGS=" -O3 -pthread"

# Don't require these features for HBBTV since they're not supported
# by some HBBTV browsers
if variants.hbbtv:
   # LIMES1 for hbbtv compatibility
   env['CFLAGS'] += " -mcpu=lime1"
   # Need to explicitly disable bigint otherwise it's still enabled
   env['LDFLAGS'] += " -sWASM_BIGINT=0"
   # Generate .js files that load the .wasm file in
   # a way that they are compatible with older versions of the browsers
   env['LDFLAGS'] += " -sEXPORT_ES6=0"
   env['LDFLAGS'] += " -sLEGACY_VM_SUPPORT=1"
   # Generate .js files focused on the web platform, not node.js
   env['LDFLAGS'] += " -sENVIRONMENT=web,worker"

   # Disable as much as possible to chase smaller binary size
   env['CFLAGS'] += ' -DGST_DISABLE_OPTION_PARSING -DGST_DISABLE_REGISTRY -DGST_DISABLE_GST_TRACER_HOOKS -DGST_REMOVE_DISABLED'

   # Only log errors. This drops all the rest of gstreamer logs at compile time,
   # so the purpose are size and performance
   env['CFLAGS'] += ' -DGST_LEVEL_MAX=1 -DGST_LEVEL_DEFAULT=1'
else:
   # SIMD, https://github.com/WebAssembly/simd	
   env['CFLAGS'] += " -msimd128 -DWASM_SIMD_COMPAT_SLOW"
   # https://github.com/WebAssembly/exception-handling
   COMMON_FLAGS += " -fexceptions"
   # BIGINT, https://github.com/WebAssembly/JS-BigInt-integration
   env['CFLAGS'] += " -DWASM_BIGINT"
   env['LDFLAGS'] += " -sWASM_BIGINT"

env['CFLAGS'] += COMMON_FLAGS
env['CFLAGS'] += " -mnontrapping-fptoint"

# PIC
env['CFLAGS'] += " -fPIC"
env['CFLAGS'] += " -I" + os.path.join(prefix, "include")

env['CXXFLAGS'] += env['CFLAGS']

env['LDFLAGS'] += COMMON_FLAGS
env['LDFLAGS'] += " -sAUTO_JS_LIBRARIES=0 -sAUTO_NATIVE_LIBRARIES=0"

if not toolchain_prefix:
    toolchain_prefix = os.path.join(home_dir, "emsdk")

dot_emscripten_config = os.path.join(toolchain_prefix, '.emscripten')
# This file might be missing if we are bootstrapping
if os.path.exists(dot_emscripten_config):
    # Parse the .emscripten config file to fetch the installed
    # sdk enviroment.
    # after execution, this config file defines:
    # BINARYEN_ROOT, EMSCRIPTEN_ROOT, LLVM_ROOT, NODE_JS
    os.environ['EM_CONFIG'] = dot_emscripten_config
    exec(open(dot_emscripten_config).read(), globals())

    def add_cmd(var, prefix, command):
        env[var] = os.path.join(prefix, command)

    add_cmd('CC', EMSCRIPTEN_ROOT, 'emcc')
    add_cmd('CXX', EMSCRIPTEN_ROOT, 'em++')
    add_cmd('AR', EMSCRIPTEN_ROOT, 'emar')
    add_cmd('LD', EMSCRIPTEN_ROOT, 'emcc')
    add_cmd('NM', LLVM_ROOT, 'llvm-nm')
    add_cmd('LDSHARED', EMSCRIPTEN_ROOT, 'emcc'),
    add_cmd('RANLIB', EMSCRIPTEN_ROOT, 'emranlib')
